# CloudWatch Module

## Overview

Creates CloudWatch alarms and EventBridge events to alert lab administrators when a lab system component has failed. This module can be used to monitor the status of any Lambda function. It also uses specific input variables to track the AWS Lab Activation and Deactivation CodeBuild builds.

## Features

* Creates CloudWatch alarms for:
    * AWS Lab activation and deactivation pipelines
    * A list of Lambda functions based on the `lambda_function_actions` input variable, which is a map of function names => action to perform 
* Creates EventBridge events for:
    * The Lambda alarms created above
    * AWS Lab activation and deactivation pipelines

## Notes

### Email function monitoring

Do not use the `notify` flag with any Lambda function that is downstream from this component, such as the Lab Emails function. This module writes messages to the `lab_status` SNS topic, which triggers the Lab Emails function, so sending notifications when the email function fails would result in a loop. Instead, use a value such as `alarm_only`.

### Alarm and email detail level

Alarms are raised based on CloudWatch Metrics, which show when a Lambda function has failed, or a CodeBuild build has failed, 1 or more times in the past minute. Metric-based alarm events don't provide any of the logs from failed runs, since they only show that an execution has failed 1 or more times. Because of this, email notifications from this module will have minimal information about the actual failure - the administrator will need to note the component that failed and investigate logs.

Also note that the Alarm notification events are based on alarm state changes - if a Lambda execution fails 100 times in 2 minutes, the administrator will only receive 1 email since the status would only have changed from OK to ALARM one time.

### Transformation templates

#### Background

This module uses [EventBridge transformation templates](https://docs.aws.amazon.com/eventbridge/latest/userguide/transform-input.html) to pull relevant data from the alarm or CodeBuild failure and insert that data into the SNS notification.

The SNS message eventually is processed by the Email Lambda function, but [EventBridge's transformation limitations](https://docs.aws.amazon.com/eventbridge/latest/userguide/transform-input.html#transform-input-issues) (specifically that "EventBridge does not support variables inside of quotes within JSON") make it difficult to pass simple unescaped JSON like the Email Lambda function expects. This makes sending a nicely formatted final email from EventBridge very complex.

Because of this limitation, a single-line email message is sent, but the input template has to be specified as a string in TF with quotes escaped to work within the format AWS expects.

(This would normally work by passing a map into `jsonencode(jsonencode(map))` in Terraform, but TF replaces the `< >` marks required by AWS with Unicode escape sequences for compatibility with older versions of Terraform.)

The unescaped JSON is below for reference.

#### Activation and Deactivation input template

```json
{
    "sender": "${var.sender_email_address}",
    "admin": "${var.admin_email_address}",
    "activation": true,
    "message_type": "failure_message",
    "subject": "[Vending Machine] Lab build failure: <project_name>",
    "body": "An internal Lab CodeBuild build has failed. | Project Name: <project_name> | Build ID: <build_id> | Status: <status>"
}
```

#### Lambda alarm state change input template

```json
{
    "sender": "${var.sender_email_address}",
    "admin": "${var.admin_email_address}",
    "activation": false,
    "message_type": "failure_message",
    "subject": "[Vending Machine] Lab Lambda alarm: <alarm_name>",
    "body": "An internal Lab Lambda Alarm has gone into an ALARM state. | State: <state> | Previous State: <previous_state> | Alarm name: <alarm_name>"
}
```

## Prerequisites

* Management account created
* Lambda functions and CodeBuild builds created

---

_All text below is generated by [terraform-docs](https://github.com/terraform-docs/terraform-docs)_

---

## Requirements

| Name | Version |
|------|---------|
| terraform | ~> 1.0.6 |
| aws | ~> 3.0 |

## Providers

| Name | Version |
|------|---------|
| aws | ~> 3.0 |

## Inputs

| Name | Description | Type | Default | Required |
|------|-------------|------|---------|:--------:|
| activation\_build\_name | Name of the Activation CodeBuild build to monitor for failures | `string` | n/a | yes |
| admin\_email\_address | Name of the Deactivation CodeBuild build to monitor for failures | `string` | n/a | yes |
| deactivation\_build\_name | Name of the Deactivation CodeBuild build to monitor for failures | `string` | n/a | yes |
| lab\_status\_topic\_arn | ARN of the Lab Status SNS topic to send messages to | `string` | n/a | yes |
| lambda\_function\_actions | Map of the names of Lambda functions to create alarms for, with the function name as the key and the value as `notify` or `alarm_only` | `map(string)` | n/a | yes |
| sender\_email\_address | Name of the Deactivation CodeBuild build to monitor for failures | `string` | n/a | yes |
| tags | Map of tags for the DDB table | `map` | `null` | no |

## Outputs

No output.